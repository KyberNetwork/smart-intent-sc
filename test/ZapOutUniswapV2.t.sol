// SPDX-License-Identifier: GPL-3.0-or-later
pragma solidity ^0.8.0;

import './Base.t.sol';

import 'src/hooks/zap-out/KSZapOutUniswapV2Hook.sol';
import 'src/interfaces/actions/IKSZapRouter.sol';

contract ZapOutUniswapV2Test is BaseTest {
  using SafeERC20 for IERC20;

  KSZapOutUniswapV2Hook zapOutHook;

  address zapRouter = 0x0e97C887b61cCd952a53578B04763E7134429e05;
  address pool = 0xB4e16d0168e52d35CaCD2c6185b44281Ec28C9Dc;
  address dai = 0x6B175474E89094C44Da98b954EedeAC495271d0F;
  address usdc = 0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48;
  address weth = 0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2;
  address swapExecutor = 0x6E4141d33021b52C91c28608403db4A0FFB50Ec6;
  bytes zapOutCalldata =
    hex'000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000003e000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000002c000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000001000000000000000000000000b4e16d0168e52d35cacd2c6185b44281ec28c9dc000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000005936d67229660000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000008ae85d849167ff996c04040c44924fd364217285e4cad818292c7ac37c0a345b000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000006b175474e89094c44da98b954eedeac495271d0f0000000000000000000000002fe67a58b9bb74a52a2759e1b8d50eb7d805a8b200000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000050e432e9e50ea972800000000000000000000000000f989d5f7926258a45b6f32cead5627fd026e185700000000000000000000000063b0a0d33fe906c668b1de4875bfaf562a9d8c5b000000000000000000000000000000000000000000000000000000006837581900000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000001b400000000000000000000000000000000000000000000000000000000000001a800000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000640000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000019c00000000000000000000000004f82e73edb06d29ff62c91ec8f5ff06571bdeb2900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001a400000000000000000000000000000000000000000000000000000000000000060000000000000000000000000b4e16d0168e52d35cacd2c6185b44281ec28c9dc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000a80000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000000000000000000000000000000000000315cb2807000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000009c0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000315cb280700000000000000000000000000000000000000000000000000000000000000020000000000000000000000006b175474e89094c44da98b954eedeac495271d0f00000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000844e21fd0e900000000000000000000000000000000000000000000000000000000000000200000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000034000000000000000000000000000000000000000000000000000000000000005800000000000000000000000000000000000000000000000000000000000000280000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000006b175474e89094c44da98b954eedeac495271d0f00000000000000000000000063b0a0d33fe906c668b1de4875bfaf562a9d8c5b000000000000000000000000000000000000000000000000000000006837581900000000000000000000000000000000000000000000000000000000000002200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000004094f1a6820000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000315cb2807000000000000000000000000f6e72db5454dd049d0788e411b06cfaf16853042000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec600000000000000000000000000000000000000000000000000000000000000200000000000000000002f134b2b84cfc000000000000002ce5025c0cb4b037000000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000006b175474e89094c44da98b954eedeac495271d0f000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000063b0a0d33fe906c668b1de4875bfaf562a9d8c5b0000000000000000000000000000000000000000000000000000000315cb280700000000000000000000000000000000000000000000023e25cbd8b13cdaaf000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000010000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000315cb280700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002677b22536f75726365223a227a61702d73657276696365222c22416d6f756e74496e555344223a2231333235312e353230393333373637303834222c22416d6f756e744f7574555344223a2231333235322e313936383530303137373332222c22526566657272616c223a22222c22466c616773223a302c22416d6f756e744f7574223a223133323530353337343739303030303030303030303030222c2254696d657374616d70223a313734383435363239372c22526f7574654944223a223a3335363133343334363433303339363232643631333333303336326433343338222c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a224e584e4e6969662f4355596a324d593554796e736b353356315372354e31674e4f49504e42344f5251576756462b75766e76544e58493647546c6251494a4933472b47674e706671757872646e38493961716e4834524563457752566d4f7a76316761596a4d59544145416d4e68656c7235694478546c656b4562746d6d3270797a4d30765439536e673645376c515a4644396e2b474737576b43364f69596f6666626f534f31616951785653502b5738576864556d42364a4d51796961324a33594730684146352b5452457738737a52766942306856676248627a474666456b527a706648317a796a6468656467493553766b2f52396976727955434a2b446b684467686c374b4536526b4f37534358415733586c7477305034374b4c2b2f50504248367632594b67666c5763334b5563766f61505a617038385a6d794e436e4c594e497358516f38306541576e713847656f68773d3d227d7d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000fa00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000000000000000000000000000455af7d4a865ac2b00000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000d2000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000455af7d4a865ac2b00000000000000000000000000000000000000000000000000000000000000020000000000000000000000006b175474e89094c44da98b954eedeac495271d0f00000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000ba4e21fd0e900000000000000000000000000000000000000000000000000000000000000200000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000006a000000000000000000000000000000000000000000000000000000000000008e000000000000000000000000000000000000000000000000000000000000005e0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000006b175474e89094c44da98b954eedeac495271d0f00000000000000000000000063b0a0d33fe906c668b1de4875bfaf562a9d8c5b000000000000000000000000000000000000000000000000000000006837581900000000000000000000000000000000000000000000000000000000000005800000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000038000000000000000000000000000000000000000000000000000000000000000408934ba230000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000002e00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000111111125421ca6dc452d289314280a0f8842a65000000000000000000000000000000000000000000000000455af7d4a865ac2b000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000aad722a403fb1c76cf9ac400000000000000000000000067336cec42645f55059eff241cb02ea5cc52ff860000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000000000002efb86442000000000000000000000000000000000000000000000000455af7d4a865ac2b0000000000000000000000000000a49e4000683753a68608403db4a0ffb50ec600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000180080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e0000000000000000000000000000000000000000000000000000000000000004064a367dd5f51fcc41f826ec218134734cbe586397fd6fd949aafad906ef84f14842129fccd71b799df41a8aeafe5c8a41411d38c68a77c54b102735ba8fb36d000000000000000000000000000000000000000000000000000000000000000146e4141d33021b52c91c28608403db4a0ffb50ec6000000000000000000000000000000000000000000000000000000000000000000000000000000000000004094f1a682000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000031761629a000000000000000000000000f6e72db5454dd049d0788e411b06cfaf16853042000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec600000000000000000000000000000000000000000000000000000000000000200000000000000000002f2b81baca5a8000000000000002cfc19c44722b6ba000000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000006b175474e89094c44da98b954eedeac495271d0f000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000063b0a0d33fe906c668b1de4875bfaf562a9d8c5b000000000000000000000000000000000000000000000000455af7d4a865ac2b00000000000000000000000000000000000000000000023f96cfa1213d9a72000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000010000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec60000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000455af7d4a865ac2b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002677b22536f75726365223a227a61702d73657276696365222c22416d6f756e74496e555344223a2231333237322e373639393639323035313233222c22416d6f756e744f7574555344223a2231333237382e383232373934393739373832222c22526566657272616c223a22222c22466c616773223a302c22416d6f756e744f7574223a223133323737313630303930303030303030303030303030222c2254696d657374616d70223a313734383435363239382c22526f7574654944223a223a3335363133343334363433303339363232643631333333303336326433343338222c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a224e5156542b4165456f746d5a446255532b5246377744497447637555753466464a55504f5151427a4b7356632f2f747149684834374151436b76615867614c414a7a44574d65566444647a3862432b624a4e77476c5253686f6931364a624a76324f782f4b6346553647626e7a35427876304249704c375976557856684d39464e795a6c6a57522f585058392f4949746a5a6d323975773857354d5942324c4d4a7568623437334e79727430754838615a6a6f787764717356536343746a4139777832485177396e7970622f5a446d4849475372322b715066724d7631614874774f544477373363327566717a3269797479724f457a4a51674d34776973377a304e66434b5a35644533703847386330685a346863646b4632734869326742445564736b39376b73374856366e69743672474442705467764f6964514a554b5373416a3054516858767646617a387a65384d724859513d3d227d7d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000fa0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000006b175474e89094c44da98b954eedeac495271d0f00000000000000000000000000000000000000000000050e432e9e50ea9728000000000000000000000000002fe67a58b9bb74a52a2759e1b8d50eb7d805a8b20000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011a7b22416374696f6e223a225a6170204f7574222c22496e5f4c6971756964697479223a22307862346531366430313638653532643335636163643263363138356234343238316563323863396463222c22496e5f4c69717569646974795f4c6162656c223a224445585f554e495357415056325f555344432f57455448222c22496e5f416d6f756e74735f555344223a2232363539352e38383832373035222c224f75745f4c6971756964697479223a22307836423137353437344538393039344334344461393862393534456564654143343935323731643046222c224f75745f4c69717569646974795f4c6162656c223a22444149222c224f75745f416d6f756e74735f555344223a2232363533312e303139363435227d000000000000';

  function setUp() public override {
    super.setUp();

    zapOutHook = new KSZapOutUniswapV2Hook();

    address[] memory actionContracts = new address[](1);
    actionContracts[0] = address(zapRouter);
    vm.prank(admin);
    router.whitelistActionContracts(actionContracts, true);

    minRate = 256_914_906_835_989_424_150_694_571;

    recipient = 0x2fE67A58b9bb74a52a2759e1B8d50eb7D805A8B2;

    amountIn = 98_092_060_911_974;

    vm.label(pool, 'UniswapV2 WETH/USDC');
    vm.label(dai, 'DAI');
    vm.label(usdc, 'USDC');
    vm.label(weth, 'WETH');
    vm.label(swapExecutor, 'Swap Executor');
  }

  function _selectFork() public override {
    FORK_BLOCK = 22_582_980;
    vm.createSelectFork('mainnet', FORK_BLOCK);
  }

  function testZapOutUniswapV2Success(uint256 mode) public {
    mode = bound(mode, 0, 2);
    IntentData memory intentData = _getIntentData();

    _setUpMainAddress(intentData, false);

    ActionData memory actionData = _getActionData(intentData.tokenData);

    vm.warp(block.timestamp + 100);
    (address caller, bytes memory daSignature, bytes memory gdSignature) =
      _getCallerAndSignatures(mode, actionData);

    vm.startPrank(caller);
    router.execute(intentData, daSignature, guardian, gdSignature, actionData);
  }

  function testZapOutUniswapV2WithSignedIntentSuccess(uint256 mode) public {
    mode = bound(mode, 0, 2);
    IntentData memory intentData = _getIntentData();

    _setUpMainAddress(intentData, true);

    ActionData memory actionData = _getActionData(intentData.tokenData);

    vm.warp(block.timestamp + 100);
    (address caller, bytes memory daSignature, bytes memory gdSignature) =
      _getCallerAndSignatures(mode, actionData);

    bytes memory maSignature = _getMASignature(intentData);
    vm.startPrank(caller);
    router.executeWithSignedIntent(
      intentData, maSignature, daSignature, guardian, gdSignature, actionData
    );
  }

  function _getIntentData() internal view returns (IntentData memory intentData) {
    KSZapOutUniswapV2Hook.ZapOutUniswapV2HookData memory hookData;
    hookData.srcTokens = new address[](1);
    hookData.srcTokens[0] = pool;
    hookData.dstTokens = new address[](1);
    hookData.dstTokens[0] = dai;
    hookData.minRates = new uint256[](1);
    hookData.minRates[0] = minRate;
    hookData.recipient = recipient;
    {
      address token0 = IUniswapV2Pair(pool).token0();
      address token1 = IUniswapV2Pair(pool).token1();
      uint256 reserve0 = IERC20(token0).balanceOf(pool);
      uint256 reserve1 = IERC20(token1).balanceOf(pool);
      uint256 priceCurrent = (reserve1 * 1e18) / reserve0;
      hookData.priceLowers = new uint256[](1);
      hookData.priceLowers[0] = (priceCurrent * 95) / 100;
      hookData.priceUppers = new uint256[](1);
      hookData.priceUppers[0] = (priceCurrent * 105) / 100;
    }

    IntentCoreData memory coreData = IntentCoreData({
      mainAddress: mainAddress,
      delegatedAddress: delegatedAddress,
      actionContracts: _toArray(zapRouter),
      actionSelectors: _toArray(IKSZapRouter.zap.selector),
      hook: address(zapOutHook),
      hookIntentData: abi.encode(hookData)
    });

    TokenData memory tokenData;
    tokenData.erc20Data = new ERC20Data[](1);
    tokenData.erc20Data[0] = ERC20Data({token: pool, amount: amountIn, permitData: ''});

    intentData = IntentData({coreData: coreData, tokenData: tokenData, extraData: ''});
  }

  function _setUpMainAddress(IntentData memory intentData, bool withSignedIntent) internal {
    deal(pool, mainAddress, amountIn);
    vm.startPrank(mainAddress);
    IERC20(pool).safeIncreaseAllowance(address(router), amountIn);
    if (!withSignedIntent) {
      router.delegate(intentData);
    }
    vm.stopPrank();
  }

  function _getActionData(TokenData memory tokenData)
    internal
    view
    returns (ActionData memory actionData)
  {
    uint256 approvalFlags = (
      1 << (tokenData.erc20Data.length + tokenData.erc721Data.length + tokenData.erc1155Data.length)
    ) - 1;

    actionData = ActionData({
      tokenData: tokenData,
      approvalFlags: approvalFlags,
      actionSelectorId: 0,
      actionCalldata: zapOutCalldata,
      hookActionData: abi.encode(0),
      extraData: '',
      deadline: block.timestamp + 1 days,
      nonce: 0
    });
  }
}
