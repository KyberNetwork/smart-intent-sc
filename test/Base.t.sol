// SPDX-License-Identifier: GPL-3.0-or-later
pragma solidity ^0.8.0;

import './mocks/ERC1155Mock.sol';
import './mocks/ERC721Mock.sol';
import './mocks/MockActionContract.sol';
import './mocks/MockIntentValidator.sol';

import './mocks/MockDex.sol';

import 'forge-std/Test.sol';

import '@openzeppelin-contracts/mocks/token/ERC20Mock.sol';

import 'src/interfaces/IKSSwapRouter.sol';

import 'src/KSSessionIntentRouter.sol';
import 'src/validators/KSSwapIntentValidator.sol';

contract BaseTest is Test {
  uint256 FORK_BLOCK = 22_085_494;

  address owner = makeAddr('owner');
  address guardian;
  uint256 guardianKey;
  address mainAddress;
  uint256 mainAddressKey;
  address delegatedAddress;
  uint256 delegatedAddressKey;
  address randomCaller = makeAddr('randomCaller');
  address recipient = 0x318d280C0dc7C0A3B4F03372F54c07d923c08ddA;

  address swapRouter = 0x6131B5fae19EA4f9D964eAc0408E4408b66337b5;
  address tokenIn = 0xdAC17F958D2ee523a2206206994597C13D831ec7;
  uint256 amountIn = 1_000_000_000;
  address tokenOut = 0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599;
  uint256 minRate = 1_107_943_200_000_000;
  bytes swapCalldata =
    hex'00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000f4a1d7fdf4890be35e71f3e0bbc4a0ec377eca3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000007a000000000000000000000000000000000000000000000000000000000000009e000000000000000000000000000000000000000000000000000000000000006e0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec70000000000000000000000002260fac5e5542a773aa44fbcfedf7c193bc2c599000000000000000000000000a9b8506c28eaa9bd51d1ff5d42047611e481a3920000000000000000000000000000000000000000000000000000000067db987b00000000000000000000000000000000000000000000000000000000000006800000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000040f59b1df7000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000002000000000000000000000000066a9893cc07d91d95644aedd05d03f95e1dba8af000000000000000000000000000000000000000000000000000000003b9aca00000000000000000000000000000000000022d473030f116ddee9f6b43ac78ba3000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec7000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000000000000000000000000000000000000000002300000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040a9d4c672000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000180000000000000000000000000655edce464cc797526600a462a8154650eee4b77000000000000000000000000000000000000000000000000000000003b9d5f1a000000000000000000000000000000000000000000000000000000003b9d5f1a00000000000000000000000000000000000000000000000006dac07944b594800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000f4a1d7fdf4890be35e71f3e0bbc4a0ec377eca3000000000000005fa94793ea0000001a371930340fc8fbcc09c409c467db9414000000000000000000000000000000000000000000000000000000000000001bdcffd1bf68c2c17dcf00a25c935efba96aa63b7f75dd43d42b3df2cf7273c2260fb4b38a9db829fbfdabcc6262ac3982f1d31366bfde12a7b67f6f31ba52b2cb0000000000000000000000000000000000000000000000000000000000000040d90ce4910000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000001000000000000000000000000007f86bf177dd4f3494b841a37e810a34dd56c829b000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000002260fac5e5542a773aa44fbcfedf7c193bc2c5990000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000006da929a6bb58cc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000010000000000000000000000000011cbb0000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec70000000000000000000000002260fac5e5542a773aa44fbcfedf7c193bc2c599000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000a9b8506c28eaa9bd51d1ff5d42047611e481a392000000000000000000000000000000000000000000000000000000003b9aca00000000000000000000000000000000000000000000000000000000000011c7210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000f4a1d7fdf4890be35e71f3e0bbc4a0ec377eca30000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000003b9aca00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024f7b22536f75726365223a22222c22416d6f756e74496e555344223a22313030302e31373135393231313738353037222c22416d6f756e744f7574555344223a22313030302e34373538333032323939323331222c22526566657272616c223a22222c22466c616773223a302c22416d6f756e744f7574223a2231313636323536222c2254696d657374616d70223a313734323434333436392c22526f7574654944223a2263383438663432632d326465322d343364382d623366372d636637366362666430363536222c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a224e39426b4975436430714961362f4d64736635717a61657863436c3754413539426e4d70454741437a74432b5875325176494a36444c34476b7075746b636f627554395657357a42744e427a5463736b4e7768434662372f6f52675173676970424e693878716d323869524b3048496834527a70316457512f437737676a58375168653270313853506966492b7550674e5a34647a5a6a4461686b664d416852796d7765783233714942536a65565a6f44483932596a534b4e546176396f2f2f634754766476336a52555538536841763153464b55514b54515470682f4d4f71534f7370646c37306632714155705274566d7739434b4d383347726164506b55546f5854684a2f6c734e784561634267395a37617a363837394d366d31517538465a687237796374367a4242524a774171464e6646436a364b523969307a4e702f665a2b6876394b6970455341666d5078634e4d67773d3d227d7d0000000000000000000000000000000000';

  KSSessionIntentRouter router;

  MockIntentValidator mockValidator;
  KSSwapIntentValidator swapValidator;

  MockActionContract mockActionContract;
  MockDex mockDex;

  ERC1155Mock erc1155Mock;
  ERC20Mock erc20Mock;
  ERC721Mock erc721Mock;

  function setUp() public virtual {
    _selectFork();

    (guardian, guardianKey) = makeAddrAndKey('guardian');
    (mainAddress, mainAddressKey) = makeAddrAndKey('mainAddress');
    (delegatedAddress, delegatedAddressKey) = makeAddrAndKey('delegatedAddress');

    address[] memory initialGuardians = new address[](1);
    initialGuardians[0] = guardian;
    router = new KSSessionIntentRouter(owner, initialGuardians, initialGuardians);

    mockValidator = new MockIntentValidator();
    swapValidator = new KSSwapIntentValidator();
    mockActionContract = new MockActionContract();
    mockDex = new MockDex();
    {
      vm.startPrank(owner);
      address[] memory validators = new address[](2);
      validators[0] = address(mockValidator);
      validators[1] = address(swapValidator);
      router.whitelistValidators(validators, true);

      address[] memory actionContracts = new address[](5);
      actionContracts[0] = address(mockActionContract);
      actionContracts[1] = address(swapRouter);
      actionContracts[2] = address(swapRouter);
      actionContracts[3] = address(mockDex);
      actionContracts[4] = address(mockActionContract);

      bytes4[] memory actionSelectors = new bytes4[](5);
      actionSelectors[0] = MockActionContract.doNothing.selector;
      actionSelectors[1] = IKSSwapRouter.swap.selector;
      actionSelectors[2] = IKSSwapRouter.swapSimpleMode.selector;
      actionSelectors[3] = MockDex.mockSwap.selector;
      actionSelectors[4] = MockActionContract.removeUniswapV4.selector;
      router.whitelistActions(actionContracts, actionSelectors, true);
      vm.stopPrank();
    }

    erc1155Mock = new ERC1155Mock();
    erc20Mock = new ERC20Mock();
    erc721Mock = new ERC721Mock();
  }

  function _selectFork() public virtual {
    vm.createSelectFork('mainnet', FORK_BLOCK);
  }

  function _getMASignature(IKSSessionIntentRouter.IntentData memory intentData)
    internal
    view
    returns (bytes memory)
  {
    bytes32 intentHash = router.hashTypedIntentData(intentData);
    (uint8 v, bytes32 r, bytes32 s) = vm.sign(mainAddressKey, intentHash);
    return abi.encodePacked(r, s, v);
  }

  function _getGDSignature(IKSSessionIntentRouter.ActionData memory actionData)
    internal
    view
    returns (bytes memory)
  {
    bytes32 actionHash = router.hashTypedActionData(actionData);
    (uint8 v, bytes32 r, bytes32 s) = vm.sign(guardianKey, actionHash);
    return abi.encodePacked(r, s, v);
  }

  function _getDASignature(IKSSessionIntentRouter.ActionData memory actionData)
    internal
    view
    returns (bytes memory)
  {
    bytes32 actionHash = router.hashTypedActionData(actionData);
    (uint8 v, bytes32 r, bytes32 s) = vm.sign(delegatedAddressKey, actionHash);
    return abi.encodePacked(r, s, v);
  }

  function _getCallerAndSignatures(
    uint256 mode,
    IKSSessionIntentRouter.ActionData memory actionData
  ) internal view returns (address caller, bytes memory daSignature, bytes memory gdSignature) {
    caller = mode == 0 ? randomCaller : (mode == 1 ? guardian : delegatedAddress);
    if (mode == 0 || mode == 1) {
      daSignature = _getDASignature(actionData);
    }
    if (mode == 0 || mode == 2) {
      gdSignature = _getGDSignature(actionData);
    }
  }

  function _toArray(address a) internal pure returns (address[] memory) {
    address[] memory array = new address[](1);
    array[0] = a;
    return array;
  }

  function _toArray(bytes4 a) internal pure returns (bytes4[] memory) {
    bytes4[] memory array = new bytes4[](1);
    array[0] = a;
    return array;
  }
}
