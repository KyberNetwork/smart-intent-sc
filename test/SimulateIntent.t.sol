// SPDX-License-Identifier: UNLICENSED
pragma solidity 0.8.26;

// import {RevertReasonParser} from 'contracts/common/RevertReasonParser.sol';

import '../src/libraries/types/ActionData.sol';
import '../src/libraries/types/IntentData.sol';
import 'forge-std/Test.sol';
import 'forge-std/console.sol';
import 'src/KSSmartIntentRouter.sol';

contract SimulateIntent is Test {
  // Test parameters
  string public RPC_URL;
  uint256 public BLOCK_NUMBER;
  address public SENDER;
  address public TARGET;
  bytes public CALL_DATA;
  uint256 public ETH_VALUE;

  function setUp() public {
    // (Step 1) Load parameters
    RPC_URL = vm.envString('BASE_NODE_URL');
    BLOCK_NUMBER = 0;
    SENDER = 0x5ACf6f6E6c0a5B8595251416B50F6c7CF9508F7E;
    TARGET = 0xCa611DEb2914056D392bF77e13aCD544334dD957;
    ETH_VALUE = 0;
    CALL_DATA =
      hex'd6e2af5a00000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000009800000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000046d29c9c940018ed11ea11bfa36604ad3f9a997a0000000000000000000000000000000000000000000000000000000000000a800000000000000000000000000000000000000000000000000000000000000b00000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000006a000000000000000000000000000000000000000000000000000000000000008a00000000000000000000000005acf6f6e6c0a5b8595251416b50f6c7cf9508f7e0000000000000000000000008b9ffb92b71bf77b9522f9b3dde755b10180887000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000100000000000000000000000000438990e3a3d4904ac5b61404efc681794eb30437000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000010000000000000000000000007c5f5a4bbd8fd63184577525326123b519429bdc0000000000000000000000000000000000000000000000000000000000000001ac9650d80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004e0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000042000000000000000000000000000000000000000000000000000000000000004600000000000000000000000005acf6f6e6c0a5b8595251416b50f6c7cf9508f7e00000000000000000000000000000000000000000000000000000000000004a000000000000000000000000000000000000000000000000000000000000000010000000000000000000000005acf6f6e6c0a5b8595251416b50f6c7cf9508f7e00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000022dae000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000c0a4146dd1eb46e4bd1d6977ffec765cfcc6f8c6d8ecb3bf903f3af4131e31fd010000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000100a4146dd1eb46e4bd1d6977ffec765cfcc6f8c6d8ecb3bf903f3af4131e31fd01000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006899bc060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000004e2000000000000000000000000000004e20000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000007c5f5a4bbd8fd63184577525326123b519429bdc0000000000000000000000000000000000000000000000000000000000022dae000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000068a6fa06000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000041ea323b8b98587fbe864e2f6bb7212a6457e301126594130e1abfbb720fbebd35584f93d77d73862945d62b421296a4ac81ea6bd3f1718d3dd7c0900ce52353af1b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000416bf8d6d861b0d8f70f35f309a9ba5c67ceccd8d67fceeeefa31a75ff60040e5d72cfe850cfc2477b2e79b608e80161ba3533cd30722778694ecad4722897b4c51c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041c4e5d73dfd9fea4bb082c513d14d5e4c6068ecd9e0d5cde4ccb8a2efa92d44297e3f1de61a72aaef14cf47f8b33b0732e9a84f0f06550250ade72adc88c71f571b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041c4e5d73dfd9fea4bb082c513d14d5e4c6068ecd9e0d5cde4ccb8a2efa92d44297e3f1de61a72aaef14cf47f8b33b0732e9a84f0f06550250ade72adc88c71f571b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000070000000000000000000000000000000000000000000000000000000000000007e00000000000000000000000000000000000000000000000000000000068ce84f10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000007c5f5a4bbd8fd63184577525326123b519429bdc0000000000000000000000000000000000000000000000000000000000022dae000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000068a6fa06000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000041ea323b8b98587fbe864e2f6bb7212a6457e301126594130e1abfbb720fbebd35584f93d77d73862945d62b421296a4ac81ea6bd3f1718d3dd7c0900ce52353af1b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003e00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000036000000000000000000000000000000000000000000000000000000000000002e4dd46508f0000000000000000000000000000000000000000000000000000000000000040ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00000000000000000000000000000000000000000000000000000000000002800000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000002011100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000022dae000000000000000000000000000000000000000000000000000000351977e6420000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda02913000000000000000000000000ca611deb2914056d392bf77e13acd544334dd95700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001bd70fa9be30000000000000000000000000000000000000000000000000000000000002003000000000000000000000000000000000000000000000000000000351977e642000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002710000000000000000000000000000027100000000000000000000000000000000000000000000000000000000000000000';

    if (BLOCK_NUMBER != 0) {
      vm.createSelectFork(RPC_URL, BLOCK_NUMBER);
    } else {
      vm.createSelectFork(RPC_URL);
    }

    // (Step 2) Set up transaction context
    deal(SENDER, ETH_VALUE);
  }

  function testSimulateZapTransaction() public {
    uint256 currentBlock = block.number;

    console.log('=== Simulation Setup ===');
    console.log('Block number:', currentBlock);
    console.log('Sender:', SENDER);
    console.log('Target:', TARGET);
    console.log('Calldata length:', CALL_DATA.length);
    console.log('ETH value:', ETH_VALUE);

    // vm.warp(1_755_773_445); // expired permit sig

    // bytes memory data = '';
    // bytes memory returndata = abi.encode(address(0x5ACf6f6E6c0a5B8595251416B50F6c7CF9508F7E));

    // vm.mockCall(address(0x01), data, returndata); // cheat call to always return 0x5ACf6f6E6c0a5B8595251416B50F6c7CF9508F7E (main address) when recover signature

    // (
    //   IntentData memory intentData,
    //   bytes memory maSignature,
    //   bytes memory daSignature,
    //   address guardian,
    //   bytes memory gdSignature,
    //   ActionData memory actionData
    // ) =
    //   abi.decode(this.excludeSig(CALL_DATA), (IntentData, bytes, bytes, address, bytes, ActionData));

    // actionData.actionSelectorId = 0; // invalid selector id

    // CALL_DATA = abi.encodeWithSelector(
    //   KSSmartIntentRouter.executeWithSignedIntent.selector,
    //   intentData,
    //   maSignature,
    //   daSignature,
    //   guardian,
    //   gdSignature,
    //   actionData
    // );

    vm.startPrank(SENDER);

    // Execute the transaction with value and calldata
    (bool success, bytes memory returnData) = TARGET.call{value: ETH_VALUE}(CALL_DATA);

    // Log transaction result
    if (success) {
      console.log('Transaction status: SUCCESS');
      if (returnData.length > 0) {
        console.log('Return data:');
        console.logBytes(returnData);
      } else {
        console.log('No return data');
      }
    } else {
      console.log('Transaction status: FAILED');
    }
  }

  function excludeSig(bytes calldata data) public pure returns (bytes memory) {
    return data[4:];
  }
}
