// SPDX-License-Identifier: GPL-3.0-or-later
pragma solidity ^0.8.0;

import './Base.t.sol';

import 'src/hooks/zap-out/KSZapOutUniswapV3Hook.sol';
import 'src/interfaces/actions/IKSZapRouter.sol';

contract ZapOutUniswapV3Test is BaseTest {
  KSZapOutUniswapV3Hook zapOutHook;

  address zapRouter = 0x0e97C887b61cCd952a53578B04763E7134429e05;
  IUniswapV3PM pm = IUniswapV3PM(0xC36442b4a4522E871399CD717aBDD847Ab11FE88);
  address pool = 0x88e6A0c2dDD26FEEb64F039a2c41296FcB3f5640;
  uint256 tokenId = 963_424;
  address outputToken = 0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48;
  bytes zapOutCalldata =
    hex'00000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000480000000000000000000000000000000000000000000000000000000000000640100000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000032000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000001000000000000000000000000c36442b4a4522e871399cd717abdd847ab11fe88000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000eb36000000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000000000020aa443a489c7a54a31a25e4bf25ce7c450e141ffd85bbbf3d6ecd7590307c45198ae85d849167ff996c04040c44924fd364217285e4cad818292c7ac37c0a345b00000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000006000000000000000000000000088e6a0c2ddd26feeb64f039a2c41296fcb3f5640000000000000000000000000c36442b4a4522e871399cd717abdd847ab11fe8800000000000000000000000000000000000000000000000000000000000eb3600000000000000000000000000000000000000000000000000000000000000040000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000006de36cac9520173d31dc6748d7bd90e41b9d192f00000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000400000000000000000000000006de36cac9520173d31dc6748d7bd90e41b9d192f0000000000000000000000000000000000000000000000000030b3594268a46e0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000495eebff5f000000000000000000000000f989d5f7926258a45b6f32cead5627fd026e185700000000000000000000000063b0a0d33fe906c668b1de4875bfaf562a9d8c5b0000000000000000000000000000000000000000000000000000000067f6564f00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000022e000000000000000000000000000000000000000000000000000000000000022200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000640000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000021600000000000000000000000004f82e73edb06d29ff62c91ec8f5ff06571bdeb29000000000000000000000000a6c883e2dde82fbed20e025bd717a6b7f34f5e6e00000000000000000000000000000000000000000000000000000000000021e00000000000000000000000000000000000000000000000000000000000000100000000000000000000000000c36442b4a4522e871399cd717abdd847ab11fe8800000000000000000000000000000000000000000000000000000000000eb3600000000000000000000000000000000000000000000000000030b3594268a46e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000003674eD9c52D903C6c3A468592Ac27Fe71B3CD849000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000160000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4800000000000000000000000000000000000000000000000000000015f82b866a000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000fa00000000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000830854917a9a393bc00000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000001d400000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000830854917a9a393bc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4800000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000001bc4e21fd0e900000000000000000000000000000000000000000000000000000000000000200000000000000000000000000f4a1d7fdf4890be35e71f3e0bbc4a0ec377eca3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000170000000000000000000000000000000000000000000000000000000000000019400000000000000000000000000000000000000000000000000000000000001640000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4800000000000000000000000063b0a0d33fe906c668b1de4875bfaf562a9d8c5b0000000000000000000000000000000000000000000000000000000067f6564f00000000000000000000000000000000000000000000000000000000000015e0000000000000000000000000000000000000000000000000000000000000000b000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000002e00000000000000000000000000000000000000000000000000000000000000460000000000000000000000000000000000000000000000000000000000000078000000000000000000000000000000000000000000000000000000000000009000000000000000000000000000000000000000000000000000000000000000a400000000000000000000000000000000000000000000000000000000000000bc00000000000000000000000000000000000000000000000000000000000000d400000000000000000000000000000000000000000000000000000000000000e8000000000000000000000000000000000000000000000000000000000000010e000000000000000000000000000000000000000000000000000000000000012e000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000004063407a490000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000f4a1d7fdf4890be35e71f3e0bbc4a0ec377eca3000000000000000000000000e0554a476a092703abdb3ef35c80e0d76d32939f000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000000000000000000000000000d1a6edb590f6c204000000000000000000000000fffd8963efd1fc6a506488495d951d5263988d25000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000004063407a490000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000f4a1d7fdf4890be35e71f3e0bbc4a0ec377eca300000000000000000000000088e6a0c2ddd26feeb64f039a2c41296fcb3f5640000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000000000000000000000000000046c1f03a142014aa1000000000000000000000000fff6fbe64b68d618d47c209fe40b0d8ee6e23c900000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000040800023a1000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000280000000000000000000000000000000000000000000000000000000000000002000000000000000000000000055084ee0fef03f14a305cd24286359a35d7351510000000000000000000000000000000000000000000000000000000000000040000000000000000000000000713dc4df480235dbe2fb766e7120cbd4041dcb58000000000000000000000000111bb8c3542f2b92fb41b8d913c01d37884311110000000000000000000000000f4a1d7fdf4890be35e71f3e0bbc4a0ec377eca300000000000000000000000063b0a0d33fe906c668b1de4875bfaf562a9d8c5b000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000000000000000000000000000e69e057aec42a22b000000000000000000000000000000000000000000000000e69e057aec42a22b00000000000000000000000000000000000000000000000000000005bf0d55920000000000000000000000000000000000000000000000000000000067f651c8000000000000000000000000000000000000000000000000000001961a2edc061120000a1000a10000871661b32668ffffffffffffff0026bbc7f415fec3000000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000000412e71371c4ac3e6440c2c71db677c482e1be9dc66fa31444f4e026c055d103ebd3810ddc9ed960dc945d53906502b172a1ceb0f70755c0d05995d060a6092f1761b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000004063407a490000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000f4a1d7fdf4890be35e71f3e0bbc4a0ec377eca30000000000000000000000006ca298d2983ab03aa1da7679389d955a4efee15c000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec70000000000000000000000000000000000000000000000003ee5475011e3a096000000000000000000000000000000000000000000000000000000010009046c000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000004088e563110000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000836951eb21f3df98273517b7249dceff270d34bf000000000000000000000000000000000000000000000000bcafd5f035aae1c7000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000000f4a1d7fdf4890be35e71f3e0bbc4a0ec377eca300000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000004063407a490000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000f4a1d7fdf4890be35e71f3e0bbc4a0ec377eca300000000000000000000000011b815efb8f581194ae79006d24e0d814b7697f6000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec70000000000000000000000000000000000000000000000003ee5475011e3a097000000000000000000000000000000000000000000000000000000010009046d000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000004063407a490000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000f4a1d7fdf4890be35e71f3e0bbc4a0ec377eca30000000000000000000000004585fe77225b41b697c938b018e2ac67ac5a20c0000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000002260fac5e5542a773aa44fbcfedf7c193bc2c59900000000000000000000000000000000000000000000000053dc5f156d2f80c9000000000000000000000000fff6fbe64b68d618d47c209fe40b0d8ee6e23c90000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000004066b77cad0000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000d17b3c9784510e33cd5b87b490e79253bcd81e2e0000000000000000000000000000000000000000000000007dca8ea023c7412f000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000000f4a1d7fdf4890be35e71f3e0bbc4a0ec377eca3000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000004025a514a50000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000002260fac5e5542a773aa44fbcfedf7c193bc2c5990000000000000000000000000000000000000000000000000000000000b143890000000000000000000000000000000002342185898ff5734d5569f53ce71201000000000000000000000000000000000000000000000000000000000000004063407a490000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000f4a1d7fdf4890be35e71f3e0bbc4a0ec377eca300000000000000000000000056534741cd8b152df6d48adf7ac51f75169a83b20000000000000000000000002260fac5e5542a773aa44fbcfedf7c193bc2c599000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec70000000000000000000000000000000000000000000000000000000000b14389000000000000000000000000000000000000000000000000000000010009046d0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000040f59b1df7000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000002000000000000000000000000066a9893cc07d91d95644aedd05d03f95e1dba8af0000000000000000000000000000000000000000000000000000000190c92b8d000000000000000000000000000000000022d473030f116ddee9f6b43ac78ba3000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec7000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000004025a514a5000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec700000000000000000000000000000000000000000000000000000003a69a526f0000000000000000000000000000000000006aff5092301daeb0a9a26e8c6dcc0000000000000000000000000000000000000000000000000000000000000040301a40330000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000a000000000000000000000000031373595f40ea48a7aab6cbcb0d377c6066e2dca00000000000000000000000000000000ffffffffffffffffffffffffffffffff000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec7000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000000f4a1d7fdf4890be35e71f3e0bbc4a0ec377eca3000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000036aed0000000000000000000000342650b23b000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000063b0a0d33fe906c668b1de4875bfaf562a9d8c5b00000000000000000000000000000000000000000000000830854917a9a393bc00000000000000000000000000000000000000000000000000000033659857c10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000f4a1d7fdf4890be35e71f3e0bbc4a0ec377eca3000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000830854917a9a393bc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000023e7b22536f75726365223a227a61702d736572766963652d7a6170222c22416d6f756e74496e555344223a223232333636322e3138313332333635303634222c22416d6f756e744f7574555344223a223232333534302e36363835383030363239222c22526566657272616c223a22222c22466c616773223a302c22416d6f756e744f7574223a22323233393530333034323030222c2254696d657374616d70223a313734343139363030312c22526f7574654944223a22222c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a22494f39616d574269614e794e356c7675386b70576c474d4934783877316b70512f573132674c7959494f3249784634664c4232774a6d5651555855452f6b674268756c594b38472f7057516472316a624e6e6e54556b5376744e4e786f64494e6242794c70735a506e75384c653264646a425a426a437a43655273784e78764b4978724c6a6e3746724235667a375833666a6c35517065437a6342632f5761706a78536d63516975735a4c776976664b514275437852556969434e5a43334e39646c4971314b5773524b5145385948436345503972507a4d4d4f632f6d774845696d596361594c755366484c42336848674b43762b657567613635625770416e672b2f6c57784c617530782f7256495a4b55586f757a30676b4633695765625671396f556645647441704e62526f37727338486f44695a4a4168624a45705678745a31684234326339397672695054554773685374413d3d227d7d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000fa000000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000000000000000000000000000000000495eebff5f0000000000000000000000006de36cac9520173d31dc6748d7bd90e41b9d192f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001347b22536f75726365223a227a61702d73657276696365222c22416374696f6e223a225a6170204f7574222c22496e5f4c6971756964697479223a22307838386536613063326464643236666565623634663033396132633431323936666362336635363430222c22496e5f4c69717569646974795f4c6162656c223a224445585f554e495357415056335f393633343234222c22496e5f416d6f756e74735f555344223a223331393231322e3731353936313233222c224f75745f4c6971756964697479223a22307841306238363939316336323138623336633164313944346132653945623063453336303665423438222c224f75745f4c69717569646974795f4c6162656c223a2255534443222c224f75745f416d6f756e74735f555344223a223331383335302e3238383236353835227d000000000000000000000000';

  function setUp() public override {
    super.setUp();

    zapOutHook = new KSZapOutUniswapV3Hook();

    address[] memory actionContracts = new address[](1);
    actionContracts[0] = address(zapRouter);
    router.whitelistActionContracts(actionContracts, true);

    recipient = 0x6dE36caC9520173d31dc6748d7bd90e41b9D192f;
    minRate = 22_060_326_920_328;

    address posOwner = pm.ownerOf(tokenId);
    vm.prank(posOwner);
    pm.safeTransferFrom(posOwner, mainAddress, tokenId);
  }

  function _selectFork() public override {
    FORK_BLOCK = 22_230_873;
    vm.createSelectFork('mainnet', FORK_BLOCK);
  }

  function testZapOutUniswapV3Success(uint256 mode) public {
    mode = bound(mode, 0, 2);
    IntentData memory intentData = _getIntentData();

    _setUpMainAddress(intentData, false);

    ActionData memory actionData = _getActionData(intentData.tokenData);

    (address caller, bytes memory daSignature, bytes memory gdSignature) =
      _getCallerAndSignatures(mode, actionData);

    vm.startPrank(caller);
    router.execute(intentData, daSignature, guardian, gdSignature, actionData);
  }

  function testZapOutUniswapV3WithSignedIntentSuccess(uint256 mode) public {
    mode = bound(mode, 0, 2);
    IntentData memory intentData = _getIntentData();

    _setUpMainAddress(intentData, true);

    ActionData memory actionData = _getActionData(intentData.tokenData);

    (address caller, bytes memory daSignature, bytes memory gdSignature) =
      _getCallerAndSignatures(mode, actionData);

    bytes memory maSignature = _getMASignature(intentData);
    vm.startPrank(caller);
    router.executeWithSignedIntent(
      intentData, maSignature, daSignature, guardian, gdSignature, actionData
    );
  }

  function _getIntentData() internal view returns (IntentData memory intentData) {
    KSZapOutUniswapV3Hook.ZapOutUniswapV3HookData memory hookData;
    hookData.nftAddresses = new address[](1);
    hookData.nftAddresses[0] = address(pm);
    hookData.nftIds = new uint256[](1);
    hookData.nftIds[0] = tokenId;
    hookData.pools = new address[](1);
    hookData.pools[0] = address(pool);
    hookData.outputTokens = new address[](1);
    hookData.outputTokens[0] = outputToken;
    hookData.offsets = new uint256[](1);
    hookData.offsets[0] = 7; // 7 is the liquidity offset
    hookData.offsets[0] |= (uint256(0) << 128); // 0 is the sqrtPriceX96 offset
    hookData.sqrtPLowers = new uint160[](1);
    hookData.sqrtPLowers[0] = 0;
    hookData.sqrtPUppers = new uint160[](1);
    hookData.sqrtPUppers[0] = type(uint160).max;
    hookData.minRates = new uint256[](1);
    hookData.minRates[0] = minRate;
    hookData.recipient = recipient;

    IntentCoreData memory coreData = IntentCoreData({
      mainAddress: mainAddress,
      delegatedAddress: delegatedAddress,
      actionContracts: _toArray(zapRouter),
      actionSelectors: _toArray(IKSZapRouter.zap.selector),
      hook: address(zapOutHook),
      hookIntentData: abi.encode(hookData)
    });

    TokenData memory tokenData;
    tokenData.erc721Data = new ERC721Data[](1);
    tokenData.erc721Data[0] = ERC721Data({token: address(pm), tokenId: tokenId, permitData: ''});

    intentData = IntentData({coreData: coreData, tokenData: tokenData, extraData: ''});
  }

  function _setUpMainAddress(IntentData memory intentData, bool withSignedIntent) internal {
    vm.startPrank(mainAddress);
    pm.approve(address(router), tokenId);
    if (!withSignedIntent) {
      router.delegate(intentData);
    }
    vm.stopPrank();
  }

  function _getActionData(TokenData memory tokenData)
    internal
    view
    returns (ActionData memory actionData)
  {
    uint256 approvalFlags = (1 << (tokenData.erc20Data.length + tokenData.erc721Data.length)) - 1;

    actionData = ActionData({
      tokenData: tokenData,
      approvalFlags: approvalFlags,
      actionSelectorId: 0,
      actionCalldata: zapOutCalldata,
      hookActionData: abi.encode(0),
      extraData: '',
      deadline: block.timestamp + 1 days,
      nonce: 0
    });
  }
}
